<div class="container">
  <h2>Registrar Nuevo Turno</h2>

  <form (ngSubmit)="onSubmit()">
    <!-- Fecha -->
    <div class="form-group">
      <label for="fecha">Fecha:</label>
      <input
        type="date"
        id="fecha"
        name="fecha"
        [(ngModel)]="turno.fecha"
        required
        class="form-control"
      >
    </div>

    <!-- Horas -->
    <div class="form-row">
      <div class="form-group">
        <label for="horaInicio">Hora Inicio:</label>
        <select
          id="horaInicio"
          name="horaInicio"
          [(ngModel)]="turno.horaInicioAgendamiento"
          required
          class="form-control"
        >
          <option value="">Seleccionar hora</option>
          @for (hora of opcionesHoras; track hora) {
            <option [value]="hora">{{hora}}</option>
          }
        </select>
      </div>

      <div class="form-group">
        <label for="horaFin">Hora Fin:</label>
        <select
          id="horaFin"
          name="horaFin"
          [(ngModel)]="turno.horaFinAgendamiento"
          required
          class="form-control"
        >
          <option value="">Seleccionar hora</option>
          @for (hora of opcionesHoras; track hora) {
            <option [value]="hora">{{hora}}</option>
          }
        </select>
      </div>
    </div>

    <!-- Validación de horas -->
    @if (turno.horaInicioAgendamiento && turno.horaFinAgendamiento && !validarHoras()) {
      <div class="error-message">
        ⚠️ La hora de inicio debe ser menor que la hora de fin
      </div>
    }

    <!-- Proveedor -->
    <div class="form-group">
      <label for="proveedor">Proveedor:</label>
      <select
        id="proveedor"
        name="proveedor"
        [(ngModel)]="turno.idProveedor"
        required
        class="form-control"
      >
        <option value="">Seleccionar proveedor</option>
        @for (proveedor of proveedores; track proveedor.id) {
          <option [value]="proveedor.id">{{proveedor.nombre}}</option>
        }
      </select>
    </div>

    <!-- Detalles de productos -->
    <div class="form-group">
      <h3>Productos</h3>
      
      <div class="nuevo-detalle">
        <select
          [(ngModel)]="nuevoDetalle.idProducto"
          name="nuevoProducto"
          class="form-control"
        >
          <option value="">Seleccionar producto</option>
          @for (producto of productosFiltrados; track producto.id) {
            <option [value]="producto.id">{{producto.nombre}}</option>
          }
        </select>
        
        <input
          type="number"
          [(ngModel)]="nuevoDetalle.cantidad"
          name="nuevaCantidad"
          min="1"
          class="form-control"
          placeholder="Cantidad"
        >
        
        <button type="button" (click)="agregarDetalle()" class="btn" [disabled]="!nuevoDetalle.idProducto || nuevoDetalle.cantidad <= 0">
          Agregar
        </button>
      </div>

      <!-- Lista de detalles agregados -->
      @if (turno.detalles.length > 0) {
        <div class="detalles-list">
          <h4>Productos agregados:</h4>
          @for (detalle of turno.detalles; track $index; let i = $index) {
            <div class="detalle-item">
              <span>
                {{ obtenerNombreProducto(detalle.idProducto) }} - {{ detalle.cantidad }} unidades
              </span>
              <button type="button" (click)="eliminarDetalle(i)" class="btn btn-eliminar">
                ✕
              </button>
            </div>
          }
        </div>
      }
    </div>

    @if (errorMessage) {
      <div class="error-message">{{ errorMessage }}</div>
    }

    <div class="form-actions">
      <button type="button" (click)="cancel()" class="btn btn-cancel">
        Cancelar
      </button>
      <button
        type="submit"
        [disabled]="isSubmitting || !validarHoras()"
        class="btn btn-primary"
      >
        @if (isSubmitting) {
          Registrando...
        } @else {
          Registrar Turno
        }
      </button>
    </div>
  </form>
</div>